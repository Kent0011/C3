# 匿名来訪検知 PoC UI 操作ガイド（日本語）

このドキュメントは，`src/main.py` に実装されている Flask アプリの Web UI（`/ui`, `/ui/dev`, `/ui/qr` など）の使い方と，GUI を中心にしたデバッグ方法をまとめたものです．

## 0. 前提

* サーバ起動コマンド（ローカル／Codespaces 共通）

  ```bash
  python src/main.py
  ```
* 主な環境変数（`.env` で設定）

  * `ROOM_ID` … このカメラ／部屋のID（例: `R-0001`）
  * `AB_BUCKET` … A/B 実験用バケット (`control` / `treatment`)
  * `KPI_LOG_PATH` … KPIログの保存先（例: `./logs/kpi_events.jsonl`）
  * `RESERVATION_API_BASE`, `LOCK_API_BASE` … 予約・スマートロックAPIのベースURL（現状はモックでもOK）

サーバ起動時，コンソールに
`Possible URLs:` 〜 という候補URLが出力されます．
そのうち `.../ui` が **運用ダッシュボード** です．

---

## 1. 画面一覧と役割

ナビゲーションバーは全ページ共通で，上部に次のリンクがあります：

* **ダッシュボード**：`/ui`
* **QR チェックイン**：`/ui/qr`
* **QR スキャン端末**：`/ui/scan`（将来のタブレット／カメラ用）
* **掲示・プライバシー説明**：`/ui/signage`
* **開発者向け（Dev）**：`/ui/dev`

### 1.1 `/ui`：運用ダッシュボード

施設運営側が日常的に見る想定の「まとめ画面」です．

画面上部：

* タイトル：「匿名チェックイン ダッシュボード」
* ナビバー：上記リンクに加え，「言語切替（日本語/English）」リンク

主なカード：

1. **現在の状態（在室人数・A/B バケット）**

   * `/metrics` の内容を 1 秒ごとに取得して表示．
   * 表示内容の例

     * 現在の在室人数（occupancy）
     * A/B バケット (`AB_BUCKET`)
     * 今日の入室／退室／フィルタ件数　など
   * `metrics` の中身は，AI カメラからの enter/exit イベントや `/simulate/visit` で更新されます．

2. **A/B 実験の KPI（enter → hit）**

   * `/kpi/summary` を 5 秒ごとに取得し，バケット別に表示．
   * 各バケットごとに

     * `enter`: カメラが「入室」と判定した人数
     * `success`: そのうち予約とマッチして「ヒット」した人数（= 来訪成功）
     * `rate`: `success / enter`
   * PoC 現状では：

     * `treatment` 側が「来訪検知＋自動チェックイン」フロー，
     * `control` 側は「カメラ検知はするが，予約に紐付けない」フローを模した形になっています（実際の挙動は `process_event` と KPI ログ更新ロジックで制御）．

3. **QR チェックイン利用率**

   * `/kpi/qr_summary` の内容を表示．
   * QR でのチェックイン試行の総数・成功数・成功率が分かります．
   * `/ui/qr` からの操作や，実機のQRスキャン端末からのリクエストがここに反映されます．

4. **ノーショー サマリ**

   * `/kpi/no_show_summary` を表示．
   * 現時点では：

     * 「ノーショーと判定された予約数」
     * バケット別の件数集計
   * ノーショー判定は，バックグラウンドスレッド `no_show_watcher` によって行われ，結果は `kpi_events.jsonl` に `no_show_detected` イベントとして記録されます．

5. **デモ操作（入室シミュレーション）**

   * 画面右側・下部にあるカード．
   * ボタン例（実装状況により文言は多少違うかもしれません）：

     * 「入室だけ1回」：`/simulate/visit` に `dwell_ms` を短めに指定して1回だけ入室イベントを送信
     * 「入退室1往復」：`/simulate/visit` に `dwell_ms` を長めに指定し，入室→少し滞在→退室を送信
     * 「メトリクスリセット」：`/metrics/reset` を叩いてカウンタと在室人数を 0 に戻す
   * 実行結果の JSON はカード内のテキストエリアに表示されます．

**使い方のイメージ**

* **普段の運用**では `/ui` を開いておけば十分：

  * 在室人数・A/B 実験の差・QR利用率・ノーショー件数がリアルタイムで追える．
* **実験やデバッグ**では：

  * `/ui/dev` や `/ui/qr` で操作 → `/ui` で結果がどう反映されるかを見る，という流れになります．

---

### 1.2 `/ui/qr`：QR チェックイン（テスト用）

タブレット端末などで QR コードを読み取ったあと，
**「reservation_id をサーバに送る」部分を手動でテストする画面**です．

主な構成：

1. **予約ID入力フォーム**

   * テキストボックスに `reservation_id`（例: `demo_001`）を入力．

2. **「チェックイン実行」ボタン**

   * `/qr/checkin` に POST:

     ```json
     { "reservation_id": "demo_001" }
     ```
   * レスポンス例：

     ```json
     {
       "ok": true,
       "matched": true,
       "reservation_id": "demo_001"
     }
     ```
   * `matched: true` の場合：

     * KPI カウンタ `checkin_success` が +1．
     * `kpi_events.jsonl` に `event: "qr_checkin", matched: true` の行が追加される．
     * `_RSV_STATE` に同じ予約IDが存在すれば，その予約が `checked_in: true` に更新され，ノーショー対象から外れます．
   * `matched: false` の場合：

     * `checkin_fail` が +1．
     * ログには `qr_checkin, matched: false` が記録されます．

3. **「ダミー予約作成」ボタン**

   * `/mock/reservations/create` に POST．
   * 例えば次のような JSON を送っています：

     ```json
     {
       "reservation_id": "demo_001",
       "start_in_min": 3,
       "duration_min": 30
     }
     ```
   * レスポンス例：

     ```json
     {
       "ok": true,
       "reservation_id": "demo_001",
       "start_ts": "...",
       "end_ts": "..."
     }
     ```
   * 内部的には `_RSV_STATE` に登録され，`no_show_watcher` / `end_watcher` の監視対象になります．

4. **右側に KPI 要約表示**

   * `/kpi/qr_summary` を定期的に取得して表示．
   * 「QR チェックイン総数」「成功数」「成功率」などが出ます．

**よくあるテスト手順**

* **(1) 正常なチェックインフロー**

  1. 「ダミー予約作成」で `demo_001` を作る（開始時刻は数分後）．
  2. 開始時刻の ±許容ウィンドウ（デフォルト T−10〜T+15 分）の間に，
     `reservation_id` に `demo_001` を入れて「チェックイン実行」．
  3. `/ui` の「QR 利用率」カードと「ノーショーサマリ」を確認：

     * `qr_success` が増えていること．
     * その予約について「no_show_detected」が発生していないこと．

* **(2) ノーショーになるケース**

  1. 別のID（例: `demo_ns_001`）でダミー予約を作る．
  2. 意図的にチェックインを行わず，開始時刻 + 許容ウィンドウ + グレース時間（`NO_SHOW_GRACE_MIN`）を過ぎるまで待つ．
  3. バックグラウンドの `no_show_watcher` が `no_show_detected` を発行し，
     `/kpi/no_show_summary` の件数が増えるのを `/ui` で確認．
  4. `/ui/dev` の「KPIログ末尾」でも `no_show_detected` の行が見えるはずです．

---

### 1.3 `/ui/scan`：QR スキャン端末用（骨組み）

* 将来的に「タブレットでカメラを起動して QR を読み取り，そのまま `/qr/checkin` を叩く」ための画面です．
* 現時点では：

  * UI のひな型と簡単な説明テキストのみ（カメラ起動やデコードロジックは未実装）．
  * 実装が追いついたら，`navigator.mediaDevices.getUserMedia` やブラウザ側のQRライブラリを組み込む予定の位置になります．

---

### 1.4 `/ui/signage`：掲示・プライバシー説明画面

* 利用者向けの **入口掲示用ページ** です．
* 主な内容（日本語）：

  * 「カメラによる匿名来訪検知システムを導入しています」
  * 「映像は保存せず，入室ライン通過のイベントのみ記録」
  * 「顔認識・個人識別は行いません」
  * 「問い合わせ先」 等
* タブレットやモニタでこのページをフルスクリーン表示することで，
  「プライバシー最小化」と「透明性」の要件を説明することを想定しています．

---

### 1.5 `/ui/dev`：開発者向けテスト・デバッグ UI

**開発中に一番お世話になる画面**です．

構成（カードごと）：

1. **現在のコンフィグ・状態**

   * `/config` と `/metrics` と `_RSV_STATE` の要約を表示．
   * ここだけ見れば，

     * 到着許容ウィンドウ（T−何分〜T+何分）
     * ノーショー猶予
     * 現在の在室人数・カウンタ
     * 登録されている予約リスト
       がまとめて把握できます．

2. **到着ウィンドウ・ノーショー猶予の更新**

   * フォーム項目例：

     * 「予約開始の◯分前からチェックイン許可」= `ARRIVAL_BEFORE_MIN`
     * 「予約開始の◯分後までチェックイン許可」= `ARRIVAL_AFTER_MIN`
     * 「ノーショー判定の猶予（分）」= `NO_SHOW_GRACE_MIN`
   * 「更新」ボタンで `/config/update` に PATCH．

     * 送信される JSON 例：

       ```json
       {
         "arrival_before_min": 10,
         "arrival_after_min": 15,
         "no_show_grace_min": 10
       }
       ```
     * サーバ側ではこれらの値をグローバル変数として更新し，
       `no_show_watcher` / `end_watcher` のロジックで参照しています．

3. **来訪イベントのシミュレーション**

   * ボタン例：

     * 「1人だけ入室」：`/simulate/visit`（短い滞在時間）
     * 「入退室1往復」：`/simulate/visit`（長めの `dwell_ms`）
   * これらは **エッジAIカメラからの JSON を完全に模したイベント** を内部で生成し，
     `process_event()` に渡すことで，実機なしでも end/enter ロジックや occupancy 更新・KPI 更新を検証できます．
   * 実行結果はカード内のテキストエリアに JSON で表示されます．

4. **予約モック操作**

   * `/mock/reservations/create`・`/mock/reservations/upcoming`・`/mock/reservations/clear` を叩くボタン群．
   * ここからもダミー予約を作成／一覧取得／リセットできます．
   * `/ui/qr` と組み合わせることで，

     * 「予約だけ作ってノーショーを待つ」
     * 「予約作った後に QR でチェックインしてノーショーが発生しないことを確認する」
       というテストが GUI だけで可能です．

5. **KPI ログ末尾表示**

   * `/kpi/tail?n=50` を叩き，`kpi_events.jsonl` の末尾 N 行を表示．
   * ここで確認できる主なイベント：

     * `edge_event`：カメラから来た生イベント
     * `enter` / `exit`：ライン通過判定
     * `qr_checkin`：QR によるチェックイン
     * `no_show_detected`：ノーショー判定
     * `reservation_closed`, `overstay_detected`：予約終了関係
   * CLI で `jq` を叩かなくても，最低限のデバッグが可能です．

---

## 2. GUI を使ったデバッグシナリオ

ここからは，「こういうことを検証したいときは，この画面をこう触る」という具体例です．

### 2.1 A/B 実験の差（control vs treatment）を確認したい

1. `/ui` を開く．
2. `/ui/dev` の「来訪イベントのシミュレーション」で，何回か「入室」または「入退室」を実行．
3. `/ui` の **A/B 実験の KPI カード** を見る：

   * `treatment` の `enter` と `success` が同じように増えている．
   * `control` 側は `enter` だけ増え，`success` は 0 のまま（PoCロジックによる）など，
     実装している差が可視化されます．
4. 必要に応じて `/ui/dev` の「KPI ログ末尾」で，生のログを確認．

> 将来的には，ここに「ノーショー率の差」「追加売上」など，よりビジネス寄りの KPI を積んでいく想定です．

---

### 2.2 ノーショー自動解放の動作を確認したい

1. `/ui/qr` または `/ui/dev` の「予約モック」からダミー予約を作成する（例: `demo_ns_001`）．
2. `/ui` で「ノーショーサマリ」の初期値を確認．
3. あえてチェックイン（QR or カメラ）を行わず，
   **開始時刻 + 許容ウィンドウ + ノーショー猶予** を過ぎるまで待つ．
4. **バックグラウンドで `no_show_watcher` が次の処理を行う**：

   * 該当予約に対して `no_show_detected` イベントを `kpi_events.jsonl` に記録．
   * （将来）予約API／鍵API／課金APIへ「自動キャンセル・再開放・ペナルティ」通知．
5. `/ui` の「ノーショーサマリ」と `/ui/dev` の「KPI ログ末尾」で，
   ノーショーが増えていることを確認．

---

### 2.3 QR チェックインの成功／失敗と KPI への反映を見たい

1. `/ui/qr` を開く．
2. `reservation_id` に既存のダミー予約ID（例: `demo_001`）を入れて「チェックイン実行」．
3. レスポンスで `matched: true` になっているか確認．
4. `/ui` → 「QR 利用率」カードで `qr_success` が増えていることを確認．
5. `/ui/dev` → 「KPI ログ末尾」で `event: "qr_checkin", matched: true` が記録されているか確認．

**失敗ケースの確認**

* 環境変数 `MOCK_QR_REQUIRE_ID=1` を付けてサーバを再起動．
* `/ui/qr` で空の `reservation_id` でチェックインを試すと，`matched: false` が返る．
* `/ui` と `/ui/dev` のログで `checkin_fail` や `matched:false` が増えていることを確認．

---

### 2.4 エッジAIカメラがなくても，カメラ部分をなんとなくテストしたい

* 実機（Sony AITRIOS）がなくても，次の2つでほぼ同じフローを通せます：

1. `/ui/dev` の「来訪イベントシミュレーション」ボタン
   → `/simulate/visit` と `process_event()` を経由して occupancy や KPI を更新．

2. 必要であれば，CLI から：

   ```bash
   curl -X POST http://127.0.0.1:8000/simulate/visit \
     -H "Content-Type: application/json" \
     -d '{"axis":"y","steps":12,"dwell_ms":800}'
   ```

   などで直接叩いても同じ挙動です．

---

## 3. 「この版でどこまで実装されているか」のざっくり整理

### 3.1 実装済み（PoC として動く部分）

* 匿名来訪検知の **サーバ側パイプライン**

  * エッジAIカメラ（想定）からのイベント受信エンドポイント
  * ライン通過判定（enter/exit）
  * 在室人数（occupancy）管理

* A/B バケット管理と KPI 集計

  * バケット別 enter / success / rate の集計
  * QR チェックイン成功率，ノーショー件数などの KPI 集計

* 予約連携の基本フロー（モック）

  * モック予約作成（`/mock/reservations/create`）
  * 到着ウィンドウ＋ノーショー猶予の設定＆監視（`no_show_watcher`）
  * 予約終了後の overstay 検知（`end_watcher`）

* QR チェックイン

  * `/qr/checkin` による成功／失敗判定と KPI 更新
  * GUI（`/ui/qr`）からの手動テスト

* GUI

  * `/ui`：運用ダッシュボード（リアルタイム更新）
  * `/ui/qr`：QR テスト用画面
  * `/ui/dev`：開発者向けデバッグ画面
  * `/ui/signage`：掲示・プライバシー説明画面
  * `/ui/scan`：QRスキャン端末用の骨組み

* ログ・時刻

  * KPI ログは `KPI_LOG_PATH` に JSONL で記録．
  * 予約関連の時刻は JST（日本時間）で記録されるように `now_iso_jst()` を使用．

### 3.2 部分的／未実装の部分

* **実機 AITRIOS カメラとの接続**

  * 現状は「エッジ側から JSON が飛んでくる前提」でサーバ側だけ実装．
  * 実際の AITRIOS SDK／Webhook 設定はまだ別作業．

* **QR スキャン端末でのリアルタイム読み取り**

  * `/ui/scan` は UI の枠のみで，ブラウザカメラの起動や QR のデコードは未実装．

* **決済・ペナルティロジックの本格実装**

  * Billing API との連携はインタフェースのみで，中身は PoC レベル．
  * 「1回目30％課金，2回目全額，3回目保証金」などの細かいルールはまだ入れていません．

* **ユーザ単位の常習判定**

  * 予約ID は扱っていますが，「ユーザID別に何回ノーショーしたか」といった履歴管理は今のところ対象外．